---
title: "Delegation_Analysis"
author: "Brandon Williams"
date: "2025-07-08"
output: html_document
---

# Access packages and data

```{r setup, include=FALSE}
# Pick file path
wd <- "C:/Users/BJW95/OneDrive - University of Pittsburgh/Documents/Projects/Delegation"
# wd <- "C:/Users/bjwil/OneDrive - University of Pittsburgh/Documents/Projects/Delegation"
setwd(wd)

# List of CRAN packages
cran_packages <- c(
  "foreign", 
  "plm", 
  "stargazer", 
  "patchwork", 
  "ks", 
  "lmtest",
  "dplyr", 
  "stringr", 
  "tidyr", 
  "ggplot2", 
  "svglite", 
  "AER",
  "estimatr"
)

# Load all packages
lapply(c("gmoTree", cran_packages), library, character.only = TRUE)

# Load in data
data <- readRDS("Data/deleg_data.rds")
lottery <- readRDS("Data/deleg_lottery.rds")
robot <- readRDS("Data/deleg_robot.rds")
dictator <- readRDS("Data/deleg_dictator.rds")

# Theme for all plots

nice_blue <- "#darkseagreen3"
nice_theme <- theme_classic(base_size = 12) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size = 13),
    axis.title = element_text(size = 11),
    axis.text = element_text(size = 10),
    axis.line = element_line(color = "black"),
    panel.grid.major.y = element_line(color = "gray90", size = 0.3),
    panel.grid.minor = element_blank()
  )

# Function to generate plots

make_offer_plot <- function(df, chat, delegation, urn_label) {
  df_plot <- df %>%
    filter(urn == urn_label, t > 10, role == "Seller",
           chat == !!chat, delegation == !!delegation) %>%
    count(minX) %>%
    mutate(prop = n / sum(n))
  
  label_main <- if (delegation) "Delegation" else "Take-it-or-Leave-It"
  y_label <- if (delegation) "Minimum Offer" else "Offer"
  title <- paste(label_main, ":", urn_label)
  
  ggplot(df_plot, aes(x = minX, y = prop)) +
    geom_col(fill = "#008080", color = "black", width = 1) +
    scale_x_continuous(breaks = 0:9, limits = c(0, 9)) +
    scale_y_continuous(limits = c(0, 0.65)) +
    xlab(y_label) + ylab("Proportion") +
    ggtitle(title) + nice_theme
}
```

Subject counts (N)

```{r}

subject_counts <- data %>%
  distinct(i, delegation, chat) %>%  
  group_by(delegation, chat) %>%
  summarise(n_subjects = n(), .groups = 'drop')

as.data.frame(subject_counts)
```

Plots (No Chat)

```{r}
# Generate no-chat plots
p1 <- make_offer_plot(data, chat = FALSE, delegation = FALSE, urn_label = "Low")
p2 <- make_offer_plot(data, chat = FALSE, delegation = FALSE, urn_label = "Middle")
p3 <- make_offer_plot(data, chat = FALSE, delegation = FALSE, urn_label = "High")
p4 <- make_offer_plot(data, chat = FALSE, delegation = TRUE, urn_label = "Low")
p5 <- make_offer_plot(data, chat = FALSE, delegation = TRUE, urn_label = "Middle")
p6 <- make_offer_plot(data, chat = FALSE, delegation = TRUE, urn_label = "High")

DrawHist <- (p1 | p2 | p3) / (p4 | p5 | p6)
DrawHist
```
Plots (Chat)

```{r}
# Generate chat-enabled plots
p1c <- make_offer_plot(data, chat = TRUE, delegation = FALSE, urn_label = "Low")
p2c <- make_offer_plot(data, chat = TRUE, delegation = FALSE, urn_label = "Middle")
p3c <- make_offer_plot(data, chat = TRUE, delegation = FALSE, urn_label = "High")
p4c <- make_offer_plot(data, chat = TRUE, delegation = TRUE, urn_label = "Low")
p5c <- make_offer_plot(data, chat = TRUE, delegation = TRUE, urn_label = "Middle")
p6c <- make_offer_plot(data, chat = TRUE, delegation = TRUE, urn_label = "High")

DrawHistc <- (p1c | p2c | p3c) / (p4c | p5c | p6c)
DrawHistc
```

Cumulative offers in Delegation 
```{r, warning=FALSE}
# Helper function to compute proportions of values available in [minX:maxX]
get_value_availability <- function(df, urn_label, chat_cond) {
  df_filtered <- df %>%
    filter(
      delegation == TRUE,
      role == "Seller",
      t > 10,
      urn == urn_label,
      chat == chat_cond
    ) %>%
    select(i, t, minX, maxX, y)
  
  total_offers <- nrow(df_filtered)
  
  expanded <- df_filtered %>%
    rowwise() %>%
    mutate(offer_values = list(minX:maxX)) %>%
    unnest(offer_values) %>%
    ungroup() %>%
    distinct(i, t, offer_values) %>%
    count(offer_values) %>%
    mutate(proportion = n / total_offers)
  
  # Fill missing values from 0 to 9 with 0
  full <- tibble(offer_values = 0:9) %>%
    left_join(expanded, by = "offer_values") %>%
    mutate(proportion = replace_na(proportion, 0))
  
  # Return a list with both the data and label
  return(list(data = full))
}


# Generate 6 datasets
plot_data <- list(
  low_nochat  = get_value_availability(data, "Low", FALSE),
  mid_nochat  = get_value_availability(data, "Middle", FALSE),
  high_nochat = get_value_availability(data, "High", FALSE),
  low_chat    = get_value_availability(data, "Low", TRUE),
  mid_chat    = get_value_availability(data, "Middle", TRUE),
  high_chat   = get_value_availability(data, "High", TRUE)
)

# Plotting function
make_availability_plot <- function(data_list, title) {
  df <- data_list$data
  prop_y0_label <- data_list$label
  
  ggplot(df, aes(x = offer_values, y = proportion)) +
    geom_col(fill = "#008080", color = "black", width = 0.8) +
    scale_x_continuous(breaks = 0:9, limits = c(0, 9)) +
    scale_y_continuous(limits = c(0, 1)) +
    xlab("Value Offered") + ylab("Proportion of Offers Including Value") +
    ggtitle(title) +
    annotate("text", x = 7.5, y = 0.9, label = prop_y0_label, size = 4.5, hjust = 1) +
    nice_theme
}


# Generate plots
p1 <- make_availability_plot(plot_data$low_nochat, "Low Urn (No Chat)")
p2 <- make_availability_plot(plot_data$mid_nochat, "Middle Urn (No Chat)")
p3 <- make_availability_plot(plot_data$high_nochat, "High Urn (No Chat)")
p4 <- make_availability_plot(plot_data$low_chat, "Low Urn (Chat)")
p5 <- make_availability_plot(plot_data$mid_chat, "Middle Urn (Chat)")
p6 <- make_availability_plot(plot_data$high_chat, "High Urn (Chat)")

# Combine with patchwork
DelegationValueAvailability <- (p1 | p2 | p3) / (p4 | p5 | p6)

# Show all
DelegationValueAvailability
```

Inefficiency Types 

```{r}
#### Inefficiency Decomposition ####

ineff_decomp <- data %>%
  filter(role == "Buyer", t > 10) %>%
  group_by(delegation, chat) %>%
  summarise(
    total_n = n(),
    breakdowns = sum(y == 0),
    suboptimal_choices = sum(y > 0 & y < theta, na.rm = TRUE),
    efficient_choices = sum(y >= theta, na.rm = TRUE),
    
    breakdown_rate = breakdowns / total_n,
    suboptimal_rate = suboptimal_choices / total_n,
    efficiency_rate = efficient_choices / total_n,
    
    .groups = "drop"
  ) %>%
  mutate(
    Mech = ifelse(delegation, "Delegation", "TIOLI"),
    Comm = ifelse(chat, "Chat", "NoChat")
  ) %>%
  select(Mech, Comm, breakdown_rate, suboptimal_rate, efficiency_rate)

# Reshape for plotting
ineff_long <- ineff_decomp %>%
  pivot_longer(cols = c(breakdown_rate, suboptimal_rate, efficiency_rate),
               names_to = "Outcome", values_to = "Rate")

ggplot(ineff_long, aes(x = interaction(Mech, Comm), y = Rate, fill = Outcome)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(
    values = c(
      "efficiency_rate" = "#D5D8DC",      # Teal Green
      "suboptimal_rate" = "#008080",      # Muted Orange
      "breakdown_rate"  = "#E76F51"       # Dusty Purple
    ),
    labels = c(
      "efficiency_rate" = "Efficient (y ≥ θ)",
      "suboptimal_rate" = "Suboptimal (0 < y < θ)",
      "breakdown_rate"  = "Breakdown (y = 0)"
    )
  ) +
  labs(
    title = "Decomposition of Buyer Decisions by Treatment",
    x = "Treatment",
    y = "Proportion of Rounds",
    fill = "Decision Outcome"
  ) +
  theme_classic(base_size = 13) +
  scale_x_discrete(labels = function(x) gsub("\\.", "\n", x))
```

Efficiency by urn x mechanism

```{r}
# Reshape the inefficiency data to long format
ineff_long <- ineff_table[, c("Mech", "Comm", "Low", "Middle", "High")] %>%
  pivot_longer(cols = c("Low", "Middle", "High"),
               names_to = "Urn", values_to = "Inefficiency") %>%
  mutate(
    Urn = factor(Urn, levels = c("High", "Middle", "Low")),
    Treatment = interaction(Mech, Comm)
  )

# Plot
ggplot(ineff_long, aes(x = Treatment, y = Inefficiency, fill = Urn)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8), width = 0.7, color = "black") +
  scale_fill_manual(
    values = c(
      "Low" = "#D5D8DC",     # Light gray
      "Middle" = "#008080",  # Teal
      "High" = "#E76F51"     # Burnt coral / high contrast
    )
  ) +
  labs(
    title = "Inefficiency Rate by Treatment and Urn",
    x = "Treatment (Delegation × Chat)",
    y = "Inefficiency Rate",
    fill = "Urn Type"
  ) +
  scale_x_discrete(labels = function(x) {
    sapply(strsplit(as.character(x), "\\."), function(p) paste0(p[1], "\n", p[2]))
  }) +
  theme_classic(base_size = 13)
```

Who gains the most through each mechanism / urn? 

```{r}

# Payoffs

payoff_summary <- data %>%
  filter(t > 10) %>%
  mutate(
    Mech = ifelse(delegation, "Delegation", "TIOLI"),
    Comm = ifelse(chat, "Chat", "NoChat")
  ) %>%
  group_by(Mech, Comm, urn, role) %>%
  summarise(avg_pay = mean(pay, na.rm = TRUE), .groups = "drop") %>%
  pivot_wider(
    names_from = role,
    values_from = avg_pay,
    names_prefix = "avg_"
  ) %>%
  mutate(
    Shape = paste(Mech, "–", Comm),
    urn = factor(urn, levels = c("Low", "Middle", "High"))
  )

payoff_summary <- payoff_summary %>%
  mutate(
    Shape = paste(Mech, "–", Comm),
    urn = factor(urn, levels = c("Low", "Middle", "High")),
    label = paste(Mech, "–", Comm, "–", urn)  # Full label
  )

# Shapes for Mech × Comm
mech_comm_shapes <- c(
  "TIOLI – NoChat"      = 16,  # filled circle
  "TIOLI – Chat"        = 17,  # filled triangle
  "Delegation – NoChat" = 15,  # filled square
  "Delegation – Chat"   = 18   # filled diamond
)

# Colors for Urn types
urn_colors <- c(
  "Low"    = "#7D7D7D",   # Slate gray
  "Middle" = "#008080",   # Teal
  "High"   = "#E76F51"    # Burnt coral
)

ggplot(payoff_summary, aes(x = avg_Seller, y = avg_Buyer)) +
  geom_point(aes(color = urn, shape = Shape), size = 4) +
  geom_text_repel(aes(label = label), size = 3.5, max.overlaps = 100) +
  scale_color_manual(values = urn_colors, name = "Urn Type") +
  scale_shape_manual(values = mech_comm_shapes, name = "Mechanism × Communication") +
  labs(
    title = "Average Buyer vs Seller Payoffs by Treatment and Urn",
    x = "Seller Payoff",
    y = "Buyer Payoff"
  ) +
  theme_classic(base_size = 13) +
  theme(
    legend.position = "right",
    legend.box = "vertical"
  )

```

Lottery data

```{r}
# Average lottery selection by 

lottery %>%
  group_by(lotteryType) %>%
  summarise(
    avgMinX = mean(lotteryMinX, na.rm = TRUE),
    neutralMinX = mean(neutralMinX)
  )


```

```{r}

robot %>%
  group_by(urn, delegation) %>%
  summarise(
    avgMinX = mean(minX, na.rm = TRUE),
  )


```

```{r}

dictator %>%
  group_by(type) %>%
  summarise(
    avgMinX = mean(action, na.rm = TRUE),
    selfish = mean(maxAction)
  )

```

